## 字段日志功能优化方案

### 核心优化建议

1. **格式化选项集成**
   - 将字段格式化选项与现有的 `LogFormatType` 集成，保持一致性
   - 提供可配置的字段格式化方式，而不是硬编码

2. **性能优化**
   - 使用对象池减少内存分配
   - 预分配 `strings.Builder` 容量
   - 使用 `sync.Pool` 复用 `FieldLogger` 对象

3. **API 增强**
   - 支持更多数据类型的字段值
   - 提供更灵活的链式调用
   - 添加批量添加字段的方法

4. **集成现有日志系统**
   - 保持与现有日志级别和格式一致
   - 复用现有的 `processLog` 方法

### 具体实现代码

1. **在 types.go 中添加字段格式化类型**

```go
// FieldFormatType 字段格式化类型
type FieldFormatType int

const (
    // KeyValueFormat 键值对格式: key1=value1 key2=value2
    KeyValueFormat FieldFormatType = iota
    // JSONFormat JSON格式: {"key1":"value1","key2":"value2"}
    JSONFormat
    // StructuredFormat 结构化格式: key1="value1" key2="value2"
    StructuredFormat
)
```

2. **在 FastLogConfig 中添加字段格式化配置**

```go
type FastLogConfig struct {
    // ... 现有字段
    FieldFormat FieldFormatType // 字段格式化类型，默认为键值对格式
}

// 在 NewFastLogConfig 中设置默认值
func NewFastLogConfig(logDirName, logFileName string) *FastLogConfig {
    // ... 现有代码
    config.FieldFormat = KeyValueFormat
    return config
}
```

3. **优化 FieldLogger 实现**

```go
// FieldLogger 字段日志构建器
type FieldLogger struct {
    logger *FastLog
    level  LogLevel
    fields map[string]interface{}
    buffer *bytes.Buffer // 复用缓冲区提高性能
}

// 使用对象池管理 FieldLogger 实例
var fieldLoggerPool = sync.Pool{
    New: func() interface{} {
        return &FieldLogger{
            fields: make(map[string]interface{}),
            buffer: bytes.NewBuffer(make([]byte, 0, 256)), // 预分配缓冲区
        }
    },
}

// WithFields 创建一个字段日志构建器
func (f *FastLog) WithFields(level LogLevel) *FieldLogger {
    fl := fieldLoggerPool.Get().(*FieldLogger)
    fl.logger = f
    fl.level = level
    // 清空之前可能存在的字段
    for k := range fl.fields {
        delete(fl.fields, k)
    }
    fl.buffer.Reset()
    return fl
}

// AddField 添加字段，支持链式调用
func (fl *FieldLogger) AddField(key string, value interface{}) *FieldLogger {
    if fl != nil && fl.fields != nil {
        fl.fields[key] = value
    }
    return fl
}

// AddFields 批量添加多个字段
func (fl *FieldLogger) AddFields(fields map[string]interface{}) *FieldLogger {
    if fl != nil && fl.fields != nil && fields != nil {
        for k, v := range fields {
            fl.fields[k] = v
        }
    }
    return fl
}

// Log 输出日志
func (fl *FieldLogger) Log(message string) {
    if fl == nil || fl.logger == nil || fl.fields == nil {
        return
    }
    
    // 格式化字段信息
    formattedFields := fl.formatFields()
    
    // 调用现有日志处理流程
    fl.logger.processLog(fl.level, message+" "+formattedFields)
    
    // 回收对象到池
    fieldLoggerPool.Put(fl)
}

// formatFields 根据配置的格式化类型格式化字段
func (fl *FieldLogger) formatFields() string {
    if len(fl.fields) == 0 {
        return ""
    }
    
    fl.buffer.Reset()
    
    switch fl.logger.config.FieldFormat {
    case JSONFormat:
        // JSON格式
        jsonBytes, err := json.Marshal(fl.fields)
        if err == nil {
            fl.buffer.Write(jsonBytes)
        }
    case StructuredFormat:
        // 结构化格式
        first := true
        for key, value := range fl.fields {
            if !first {
                fl.buffer.WriteString(" ")
            }
            first = false
            fl.buffer.WriteString(key)
            fl.buffer.WriteString("=\"")
            fmt.Fprintf(fl.buffer, "%v", value)
            fl.buffer.WriteString("\"")
        }
    default:
        // 默认键值对格式
        first := true
        for key, value := range fl.fields {
            if !first {
                fl.buffer.WriteString(" ")
            }
            first = false
            fl.buffer.WriteString(key)
            fl.buffer.WriteString("=")
            fmt.Fprintf(fl.buffer, "%v", value)
        }
    }
    
    return fl.buffer.String()
}
```

### 使用示例

```go
// 创建日志实例
logger := fastlog.NewFastLog(config)

// 使用字段日志
logger.WithFields(fastlog.INFO).
    AddField("user_id", 12345).
    AddField("action", "login").
    AddField("ip", "192.168.1.1").
    Log("User login event")

// 批量添加字段
logger.WithFields(fastlog.DEBUG).
    AddFields(map[string]interface{}{
        "request_id": "abc-123",
        "duration_ms": 42,
        "status_code": 200,
    }).
    Log("API request completed")
```

        